# LCE Bridge Dev Runtime Image
#
# This Dockerfile exposes multiple targets so `make run` can build only what
# the selected child app needs:
#   - bridge-zebra : Elixir + .NET + USB helpers
#   - bridge-rfid  : Elixir + Node + Java
#   - bridge-all   : Elixir + .NET + Node + Java

FROM hexpm/elixir:1.16.2-erlang-26.2.5-debian-bookworm-20240513-slim AS bridge-dev-base

SHELL ["/bin/bash", "-lc"]

# Common build/runtime tools for Phoenix dev workflow.
RUN apt-get update -y \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    bash \
    ca-certificates \
    curl \
    git \
    build-essential \
  && rm -rf /var/lib/apt/lists/*

# Pre-install hex + rebar so startup does not download them.
RUN mix local.hex --force && mix local.rebar --force

WORKDIR /app

# Seed Elixir deps/_build into image; runtime script copies these into mounted
# caches only once.
COPY mix.exs mix.lock ./
RUN mix deps.get

COPY config/config.exs config/dev.exs config/
RUN MIX_ENV=dev mix deps.compile

RUN cp -a /app/deps /app/_image_deps \
 && cp -a /app/_build /app/_image_build

RUN rm -rf /app/deps /app/_build /app/config /app/mix.exs /app/mix.lock

FROM bridge-dev-base AS bridge-rfid

RUN apt-get update -y \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    nodejs \
    openjdk-17-jre-headless \
  && rm -rf /var/lib/apt/lists/*

CMD ["bash"]

FROM mcr.microsoft.com/dotnet/sdk:10.0 AS dotnet

FROM bridge-dev-base AS bridge-zebra

RUN apt-get update -y \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    libusb-1.0-0 \
    usbutils \
    libicu72 \
    libssl3 \
    libstdc++6 \
    zlib1g \
  && rm -rf /var/lib/apt/lists/*

# Zebra child app uses `dotnet run`, so SDK is required.
COPY --from=dotnet /usr/share/dotnet /usr/share/dotnet
RUN ln -sf /usr/share/dotnet/dotnet /usr/bin/dotnet
ENV DOTNET_ROOT=/usr/share/dotnet
ENV PATH="/usr/share/dotnet:${PATH}"

CMD ["bash"]

FROM bridge-zebra AS bridge-all

RUN apt-get update -y \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    nodejs \
    openjdk-17-jre-headless \
  && rm -rf /var/lib/apt/lists/*

CMD ["bash"]
